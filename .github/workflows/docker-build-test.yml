name: Docker Build Test

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Docker Compose 환경에서 통합 테스트
  docker-integration-test:
    name: Docker Integration Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services with docker-compose
        run: |
          docker-compose up -d
          sleep 30  # 서비스 시작 대기

      - name: Run backend tests in container
        run: |
          docker-compose exec -T backend ./gradlew test || true
        continue-on-error: true

      - name: Health check
        run: |
          curl -f http://localhost:8080/actuator/health || exit 1
        continue-on-error: true

      - name: Stop services
        if: always()
        run: docker-compose down -v

